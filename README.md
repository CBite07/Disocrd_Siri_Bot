<p align="center">
  <a href="https://github.com/CBite07/Disocrd_Siri_Bot">
    <img src="./DiscordSiri/assets/Union.svg" width="160" alt="Siri Bot Logo" />
  </a>
</p>

<p align="center">
  <a href="https://discord.gg/G9NAJzpxEM"><img alt="Discord" src="https://img.shields.io/badge/Discord-Join-5865F2?style=for-the-badge&logo=discord&logoColor=white"></a>
  <a href="https://www.youtube.com/@FCPUG"><img alt="YouTube" src="https://img.shields.io/badge/YouTube-FCPUG-FF0000?style=for-the-badge&logo=youtube&logoColor=white"></a>
  <a href="https://github.com/CBite07/Disocrd_Siri_Bot"><img alt="GitHub" src="https://img.shields.io/badge/GitHub-Repo-2b2b2b?style=for-the-badge&logo=github&logoColor=white"></a>
</p>

---

## 1. 개요 및 목표

-   **프로젝트명**: `Siri Bot`
-   **목표**: 디스코드 서버 내 커뮤니티 활성화를 위한 다기능 봇 개발. 출석 체크를 통한 XP 획득, 레벨링, 역할 부여 시스템을 통해 사용자의 지속적인 참여를 유도.
-   **핵심 철학**: "소프트 코딩"을 지향하여, 향후 기능 확장이 용이한 모듈식 구조로 설계. **50년 이상** 운영 가능한 장기 프로젝트를 목표로 함.

---

## 2. 핵심 기능 명세 (User Stories)

### 2.1. 출석 체크 및 레벨링 시스템 (Phase 1)

> **사용자 스토리:**
> 서버 멤버로서, `/ㅊㅊ` 명령어를 사용하여 매일 출석 체크를 하고 싶다. 이를 통해 XP를 얻고 레벨을 올리는 재미를 느끼고 싶다.
> 내 현재 레벨과 다음 레벨까지 남은 경험치를 퍼센트(%)로 확인하고 싶다. (`/정보` 명령어)
> 내 레벨이 오르면, 서버에서 정해진 규칙에 따라 자동으로 새로운 역할을 부여받고 싶다.

**요구사항:**

-   **명령어**: `/ㅊㅊ` (슬래시 명령어)
-   **쿨다운**: 1일 1회 (매일 오전 7시 초기화, UTC 기준)
-   **XP 시스템**:
    -   XP 수치는 사용자에게 직접 노출되지 않음.
    -   레벨업에 필요한 XP는 기하급수적으로 증가시켜 100레벨 달성이 매우 어렵도록 설계 (장기 프로젝트 지향).
    -   **XP 공식 (예시)**: `다음 레벨 필요 XP = 100 * (현재 레벨 ^ 1.5)`
        > _이 공식은 초기 제안이며, 실제 난이도를 보며 조정이 필요합니다._
-   **레벨 표시**:
    -   `/레벨` 명령어 사용 시, `[현재 레벨]`과 `[다음 레벨까지 진행도 %]`를 표시.
    -   예시: `레벨 10 (다음 레벨까지 45%)`
-   **역할 자동 부여**:
    -   특정 레벨 도달 시, 사전에 정의된 역할을 자동으로 부여/변경.
    -   **주의**: **봇보다 높은 권한을 가진 관리자에게는 역할을 부여할 수 없으며, 이 경우 로그에만 기록합니다.**

### 2.2. 리더보드 (Phase 2)

> **사용자 스토리:**
> 서버 멤버로서, 서버 내 다른 유저들의 레벨 순위를 확인하고 싶다. 이를 통해 건전한 경쟁심을 느끼고 더 적극적으로 활동하고 싶다.

**요구사항:**

-   **명령어**: `/리더보드`
-   **기능**: 서버 내 유저들의 레벨 순위를 상위 10명까지 표시.
-   **표시 정보**: 순위, 유저 이름, 레벨

### 2.3. 공지 및 규칙 시스템 (Phase 3)

> **사용자 스토리:**
> 서버 관리자로서, 봇을 사용해 깔끔하게 정리된 형식의 규칙이나 공지를 특정 채널에 게시하고 싶다.

**요구사항:**

-   **명령어**: `/공지 [제목] [내용]`
-   **규칙 관리**: `/규칙` 내용은 자주 변경되지 않으므로, `JSON` 파일에서 내용을 읽어와 임베드로 표시.
-   **메시지 관리**: 기존에 봇이 보낸 규칙이나 공지 임베드가 있다면, 삭제 후 새로 전송.
-   **권한**: 관리자만 사용 가능.
-   **기능**: 디스코드의 '임베드(Embed)' 기능을 사용하여 제목, 내용, 색상 등이 포함된 깔끔한 메시지를 생성하고 지정된 채널에 전송.

### 2.4. 관리자 기능 (Phase 4)

> **사용자 스토리:**
> 서버 관리자로서, 특정 유저의 XP나 레벨을 수동으로 조정하거나 데이터를 초기화하고 싶다. 이벤트 보상이나 문제 발생 시 대응을 위함.

**요구사항:**

-   **명령어**:
    -   `/xp-추가 [유저] [수량]`
    -   `/xp-제거 [유저] [수량]`
    -   `/데이터-초기화 [유저]`
-   **확인 절차**: 데이터 초기화 시, **실수를 방지하기 위해 확인 메시지를 한 번 더 출력** (명령어를 사용한 관리자에게만 보이는 `ephemeral` 메시지).
-   **권한**: 서버 관리자(`Administrator`) 역할을 가진 유저만 사용 가능.

---

### 2.5. 음악 재생 시스템 (Phase 5)

> 사용자 스토리:
> 서버 멤버로서, 음성 채널에서 유튜브 음악을 재생/일시정지/정지하고 싶다. 반복 재생과 자동 퇴장 등 기본 동작이 안정적으로 작동하길 원한다.

**요구사항/동작:**

-   **명령어**: `/재생 [유튜브 URL 또는 검색어]`
    -   사용자는 먼저 음성 채널에 접속해야 함. 접속하지 않은 경우 에러 안내.
    -   재생 중에는 메시지에 표시되는 3개의 버튼으로 제어:
        -   ⏸️(일시정지/재생 토글), 🔄/🔂(반복 토글), ⏹️(정지 및 퇴장)
-   **재생 모델**: 단일 트랙 재생(큐 없음, 간결성과 안정성 우선)
-   **타임아웃**:
    -   5분간 유휴 상태면 자동 퇴장
    -   봇만 혼자 채널에 5분간 남아있으면 자동 퇴장
-   **지역/HTTPS**:
    -   HTTPS 강제 및 지역 우회(기본 US) 옵션 제공
    -   필요 시 프록시 설정 가능
-   **오류 처리**:
    -   비공개/삭제/지역 제한/네트워크 문제에 대한 사용자 메시지 제공
    -   스트림 시작 실패/오디오 소스 생성 실패 시 자동 퇴장으로 정리

**의존성:**

-   Python 패키지: `discord.py`, `yt-dlp`, `PyNaCl`
-   시스템 패키지: `ffmpeg` (오디오 디코딩/스트리밍에 필수)

**설정(환경 변수):**

-   `MUSIC_USE_HTTPS` (기본: `True`) — HTTPS 사용 여부
-   `MUSIC_GEO_BYPASS` (기본: `True`) — 지역 우회 사용
-   `MUSIC_PROXY_URL` — 필요 시 HTTPS 프록시 URL 지정 (예: `https://user:pass@host:port`)
-   `YOUTUBE_COOKIES_PATH` — YouTube 쿠키 파일 경로 (봇 차단 우회, 선택)

**운영 팁:**

-   유튜브 측 변경으로 `yt-dlp`가 수시로 업데이트됩니다. 정기적으로 최신화하세요:
    -   가상환경 활성화 후: `pip install -U yt-dlp`
-   Ubuntu에 `ffmpeg` 설치: `sudo apt update && sudo apt install -y ffmpeg`
-   **봇 차단 우회**: YouTube가 "Sign in to confirm you're not a bot" 오류를 반환하는 경우:
    -   이미 `player_client=ios,android` 설정이 적용되어 있어 대부분의 차단을 우회합니다
    -   여전히 문제가 있다면 프록시(`MUSIC_PROXY_URL`) 설정을 고려하세요
    -   또는 브라우저 쿠키를 추출하여 사용하는 방법도 있습니다 (고급)

---

## 2.6. Siri ↔ GPT 연동 (듀얼 봇 구성)

- 개요: Siri 봇은 사용자 인터페이스(명령 수신 및 피드백)를 담당하고, GPT 봇은 음악 재생 같은 실행 작업을 담당합니다. 두 봇은 내부 HTTP API로 통신합니다.
- 동작 요약:
    - 사용자가 Siri 봇에 `/재생 [검색어]` 명령을 입력합니다.
    - Siri 봇은 사용자의 음성 채널 정보와 검색어를 GPT 봇의 `/play` API로 전송합니다.
    - GPT 봇이 해당 길드의 음성 채널에 접속하여 재생을 시작합니다.

### 설정

- `.env` 파일에 다음 항목을 추가/설정하세요:
    - `SIRI_BOT_TOKEN` — Siri 봇 토큰
    - `GPT_BOT_TOKEN` — GPT 봇 토큰
    - `GPT_BOT_API_HOST` — GPT API 호스트 (기본: localhost)
    - `GPT_BOT_API_PORT` — GPT API 포트 (기본: 5000)

### 실행

- Siri 봇 시작 (프로젝트 루트에서):

```bash
# Siri 봇 실행
python3 src/run.py
```

- GPT 봇 시작 (프로젝트 루트에서):

```bash
# GPT 봇 실행 (별도 프로세스)
python3 src/gpt_bot.py
```

### API 엔드포인트

- `/play` (POST) — Siri → GPT 재생 요청
    - body: {"query": "검색어 또는 URL", "guild_id": int, "channel_id": int, "user": "사용자 이름"}
- `/stop` (POST) — Siri → GPT 정지 요청

---

## 2.7. TTS (Text-to-Speech) 기능

- 개요: Siri 봇은 서버 내 상태 알림(예: 재생 시작, 재생 중단)을 TTS로 안내할 수 있습니다. 기본 구현은 `cogs.voice`에서 제공되며 Edge-TTS 기반입니다.

### 사용 방법

- `.env` 설정에서 `COMMAND_PREFIX`와 봇 토큰이 올바르게 설정되어 있는지 확인하세요.
- `/tts [메시지]` 또는 `/음성알림 [메시지]` 같은 커스텀 명령(설치된 Cog에 따라 다름)을 통해 TTS를 실행할 수 있습니다.

### 권장 의존성

- `edge-tts` (Windows/Mac/Linux에서 모두 사용 가능)
- 시스템에 `ffmpeg`가 설치되어 있어야 합니다 (오디오 합성 및 전송용)

### 운영 팁

- TTS 음량/음성 설정은 `cogs/voice.py` 내부에서 조정할 수 있습니다.
- 서버 환경(특히 리눅스)에서는 `ffmpeg`와 `libopus`가 설치되어 있어야 안정적으로 작동합니다.


## 3. 기술 설계 및 데이터베이스

-   **라이브러리**: `discord.py`
-   **구조**: `Cogs`를 활용한 모듈식 구조. 각 기능(출석, 리더보드 등)을 별도의 파일로 분리하여 유지보수와 기능 확장 용이성 확보.
-   **데이터베이스**:
    -   **초기**: `SQLite` 사용 권장 (파일 기반으로 초기 개발 및 테스트에 편리).
    -   **장기**: 프로젝트 확장 시 `PostgreSQL` 또는 `MySQL` 같은 전문 데이터베이스로 마이그레이션 고려.
-   **데이터 모델 (테이블 구조 예시)**:
    -   `users` 테이블:
        -   `user_id` (INTEGER, PRIMARY KEY): 유저의 고유 디스코드 ID
        -   `guild_id` (INTEGER): 서버(길드)의 고유 ID
        -   `xp` (INTEGER, DEFAULT 0): 현재 경험치
        -   `level` (INTEGER, DEFAULT 1): 현재 레벨
        -   `last_attendance` (TEXT): 마지막 출석체크 날짜 (YYYY-MM-DD 형식)

---

## 4. 레벨 및 역할 부여 계획

아래 표는 레벨에 따른 역할 부여 계획입니다. (레벨 구간은 논의 후 조정 가능)

| 레벨 구간 | 역할 이름     | 역할 ID             |
| :-------- | :------------ | :------------------ |
| `1 - 9`   | 초보자        | `1392422549174091868` |
| `10 - 19` | 입문자        | `1392431487697293465` |
| `20 - 29` | 숙련자        | `1392431532592857182` |
| `30 - 39` | 전문가        | `1392431564574687323` |
| `40 - 49` | 마스터        | `1392431591304990730` |
| `50 - 69` | 그랜드마스터  | `1392431665376264192` |
| `70+`     | 레전드        | `1392431727292448922` |

---

## 5. 개발 로드맵

-   **1단계: 기본 환경 구축**
    -   `discord.py` 설치 및 봇 토큰 발급.
    -   기본 봇 클라이언트 코드 작성 및 서버 초대.
    -   `Cogs`를 사용한 명령어 모듈화 구조 설계.
-   **2단계: 출석 및 레벨링 기능 개발**
    -   `SQLite` 데이터베이스 생성 및 `users` 테이블 정의.
    -   `/ㅊㅊ` 명령어 구현 (DB에 XP 추가 및 마지막 출석일 기록).
    -   XP에 따른 레벨 계산 로직 구현.
    -   `/레벨` 명령어 구현 (현재 레벨 및 진행도 % 표시).
-   **3단계: 역할 자동 부여 시스템**
    -   레벨업 시 역할 변경 로직 추가.
    -   설정된 레벨에 따라 역할 자동 부여/제거 기능 구현.
-   **4단계: 리더보드 및 추가 기능**
    -   `/리더보드` 명령어 구현.
    -   `/공지`, `/규칙` 등 관리자용 임베드 메시지 기능 구현.
-   **5단계: 안정화 및 고도화**
    -   관리자용 데이터 수정 명령어 구현.
    -   코드 리팩토링 및 오류 처리 강화.
    -   (추후) 강의 알림 시스템 등 추가 기능 기획 및 개발.
